<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naviser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0f172a;
  color:#fff;
}
#app{
  max-width:480px;
  margin:auto;
  padding:10px;
  position:relative;
}
#map{
  height:55vh;
  border-radius:20px;
}
.panel{
  backdrop-filter:blur(14px);
  background:rgba(255,255,255,.15);
  border-radius:16px;
  padding:10px;
}
button{
  border:none;
  border-radius:12px;
  padding:8px;
  font-size:14px;
}
.round{
  position:absolute;
  width:40px;
  height:40px;
  border-radius:50%;
  backdrop-filter:blur(14px);
  background:rgba(255,255,255,.15);
  color:white;
  z-index:5000;
}
#themeToggle{top:10px;right:10px;}
#fullscreenToggle{top:60px;right:10px;}
#installBtn{top:110px;right:10px;display:none;}

#infoBox{
  margin-top:10px;
  font-size:13px;
}
#toolbar{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
#toolbar button{flex:1 1 48%;}

footer{
  text-align:center;
  font-size:12px;
  margin-top:20px;
  opacity:.6;
}

#offline{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:#dc2626;
  padding:6px 14px;
  border-radius:20px;
  display:none;
  z-index:9000;
}

/* ===== FULLSCREEN MODE (FIXED) ===== */
:fullscreen #map{
  height:100vh !important;
  width:100vw !important;
  border-radius:0 !important;
}

/* Hide non-essential UI */
:fullscreen #toolbar,
:fullscreen footer{
  display:none;
}

/* KEEP geolocation visible */
:fullscreen #infoBox{
  position:fixed;
  top:10px;
  left:10px;
  right:10px;
  z-index:6000;
  font-size:13px;
  background:rgba(0,0,0,0.35);
}
</style>
</head>

<body>
<div id="app">

<button id="themeToggle" class="round">üåô</button>
<button id="fullscreenToggle" class="round">‚õ∂</button>
<button id="installBtn" class="round">‚¨áÔ∏è</button>

<div id="map"></div>

<div id="infoBox" class="panel">
  <div id="locInfo">Waiting for GPS‚Ä¶</div>
  <div id="distInfo">Distance: 0 km</div>
</div>

<div id="toolbar" class="panel">
  <button onclick="addMarker()">‚ûï Add Marker</button>
  <button onclick="removeMarker()">‚ûñ Remove Marker</button>
  <button onclick="toggleUnit()">üìè KM / Mile</button>
</div>

<footer>¬© Mamik Roy 2025. All Rights Reserved.</footer>
</div>

<div id="offline">Offline Mode</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map,userMarker,markers=[],line,km=true;

/* MAPS */
const maps={
 Standard:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
 Satellite:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}),
 Terrain:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17}),
 Dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}),
 Minimal:L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19})
};

map=L.map('map',{center:[20,78],zoom:5,layers:[maps.Standard]});
L.control.layers(maps).addTo(map);

/* GEOLOCATION */
navigator.geolocation.watchPosition(p=>{
 const c=p.coords;
 if(!userMarker){
  userMarker=L.marker([c.latitude,c.longitude]).addTo(map);
  map.setView([c.latitude,c.longitude],15);
 }else userMarker.setLatLng([c.latitude,c.longitude]);
 locInfo.innerHTML=
 `Lat: ${c.latitude.toFixed(5)}<br>
  Lng: ${c.longitude.toFixed(5)}<br>
  Accuracy: ${c.accuracy} m<br>
  Altitude: ${c.altitude ?? 'N/A'}`;
});

/* MARKERS & DISTANCE */
function addMarker(){
 const c=map.getCenter();
 const m=L.marker(c,{draggable:true}).addTo(map);
 m.on('drag',calcDistance);
 markers.push(m);
 saveMarkers();
 calcDistance();
}
function removeMarker(){
 if(markers.length){
  map.removeLayer(markers.pop());
  saveMarkers();
  calcDistance();
 }
}
function calcDistance(){
 if(line) map.removeLayer(line);
 if(markers.length<2){
  distInfo.innerText='Distance: 0';
  return;
 }
 line=L.polyline(markers.map(m=>m.getLatLng())).addTo(map);
 let d=0;
 for(let i=1;i<markers.length;i++)
  d+=markers[i-1].getLatLng().distanceTo(markers[i].getLatLng());
 distInfo.innerText=`Distance: ${(km?d/1000:d/1609).toFixed(2)} ${km?'km':'mile'}`;
}
function toggleUnit(){km=!km;calcDistance();}

/* INDEXED DB */
let db;
indexedDB.open("NaviserDB",1).onupgradeneeded=e=>{
 e.target.result.createObjectStore("m",{autoIncrement:true});
};
indexedDB.open("NaviserDB",1).onsuccess=e=>{
 db=e.target.result;
 db.transaction("m").objectStore("m").getAll().onsuccess=r=>{
  r.target.result.forEach(p=>{
   const m=L.marker([p.lat,p.lng],{draggable:true}).addTo(map);
   m.on('drag',saveMarkers);
   markers.push(m);
  });
  calcDistance();
 };
};
function saveMarkers(){
 if(!db) return;
 const tx=db.transaction("m","readwrite");
 const s=tx.objectStore("m");
 s.clear();
 markers.forEach(m=>s.add(m.getLatLng()));
}

/* THEME */
themeToggle.onclick=()=>{
 document.body.classList.toggle('dark');
 themeToggle.textContent=themeToggle.textContent==='üåô'?'‚òÄÔ∏è':'üåô';
};

/* FULLSCREEN */
fullscreenToggle.onclick=()=>{
 if(!document.fullscreenElement)
  document.documentElement.requestFullscreen();
 else document.exitFullscreen();
};
document.addEventListener('fullscreenchange',()=>setTimeout(()=>map.invalidateSize(),300));

/* OFFLINE */
function net(){offline.style.display=navigator.onLine?'none':'block';}
window.addEventListener('online',net);
window.addEventListener('offline',net);
net();

/* PWA INSTALL */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
 e.preventDefault();
 deferredPrompt=e;
 installBtn.style.display='block';
});
installBtn.onclick=async()=>{
 deferredPrompt.prompt();
 await deferredPrompt.userChoice;
 deferredPrompt=null;
 installBtn.style.display='none';
};

/* SERVICE WORKER */
if('serviceWorker' in navigator)
 navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
