<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naviser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0f172a;
  color:#fff;
  display:flex;
  justify-content:center;
}

/* APP FRAME */
#app{
  width:100%;
  max-width:480px;
  padding:10px;
  position:relative;
}

/* MAP */
#map{
  height:55vh;
  border-radius:20px;
  overflow:hidden;
}

/* UI */
.panel{
  backdrop-filter:blur(14px);
  background:rgba(255,255,255,.15);
  border-radius:16px;
  padding:10px;
}
button{
  border:none;
  border-radius:12px;
  padding:8px;
  font-size:14px;
}
.round{
  position:absolute;
  width:40px;
  height:40px;
  border-radius:50%;
  backdrop-filter:blur(14px);
  background:rgba(255,255,255,.15);
  color:white;
  z-index:3000;
}
#themeToggle{top:10px;right:10px;}
#fullscreenToggle{top:60px;right:10px;}
#installBtn{top:110px;right:10px;display:none;}

#infoBox{
  margin-top:10px;
  font-size:13px;
}

#toolbar{
  margin-top:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
#toolbar button{flex:1 1 48%;}

footer{
  text-align:center;
  font-size:12px;
  margin-top:16px;
  opacity:.6;
}

/* OFFLINE */
#offline{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:#dc2626;
  padding:6px 14px;
  border-radius:20px;
  display:none;
  z-index:9000;
}

/* ===== FULLSCREEN (CORRECTED) ===== */
#app:fullscreen{
  max-width:none;
  width:100vw;
  height:100vh;
  padding:0;
}

#app:fullscreen #map{
  height:100%;
  width:100%;
  border-radius:0;
}

#app:fullscreen #toolbar,
#app:fullscreen footer{
  display:none;
}

#app:fullscreen #infoBox{
  position:absolute;
  bottom:10px;
  left:10px;
  right:10px;
  z-index:4000;
  background:rgba(0,0,0,0.35);
}
</style>
</head>

<body>

<div id="app">

<button id="themeToggle" class="round">üåô</button>
<button id="fullscreenToggle" class="round">‚õ∂</button>
<button id="installBtn" class="round">‚¨áÔ∏è</button>

<div id="map"></div>

<div id="infoBox" class="panel">
  <div id="locInfo">Waiting for GPS‚Ä¶</div>
  <div id="distInfo">Distance: 0 km</div>
</div>

<div id="toolbar" class="panel">
  <button onclick="addMarker()">‚ûï Add Marker</button>
  <button onclick="removeMarker()">‚ûñ Remove Marker</button>
  <button onclick="toggleUnit()">üìè KM / Mile</button>
</div>

<footer>¬© Manik Roy 2025. All Rights Reserved.</footer>
</div>

<div id="offline">Offline Mode</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map,userMarker,markers=[],line,km=true;

/* MAP */
map=L.map('map',{center:[20,78],zoom:5});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

/* GEOLOCATION */
navigator.geolocation.watchPosition(p=>{
 const c=p.coords;
 if(!userMarker){
  userMarker=L.marker([c.latitude,c.longitude]).addTo(map);
  map.setView([c.latitude,c.longitude],15);
 }else userMarker.setLatLng([c.latitude,c.longitude]);

 locInfo.innerHTML=
 `Lat: ${c.latitude.toFixed(5)}<br>
  Lng: ${c.longitude.toFixed(5)}<br>
  Accuracy: ${c.accuracy} m<br>
  Altitude: ${c.altitude ?? 'N/A'}`;
});

/* MARKERS */
function addMarker(){
 const c=map.getCenter();
 const m=L.marker(c,{draggable:true}).addTo(map);
 m.on('drag',calcDistance);
 markers.push(m);
 calcDistance();
}
function removeMarker(){
 if(markers.length){
  map.removeLayer(markers.pop());
  calcDistance();
 }
}
function calcDistance(){
 if(line) map.removeLayer(line);
 if(markers.length<2){distInfo.innerText='Distance: 0';return;}
 line=L.polyline(markers.map(m=>m.getLatLng())).addTo(map);
 let d=0;
 for(let i=1;i<markers.length;i++)
  d+=markers[i-1].getLatLng().distanceTo(markers[i].getLatLng());
 distInfo.innerText=`Distance: ${(km?d/1000:d/1609).toFixed(2)} ${km?'km':'mile'}`;
}
function toggleUnit(){km=!km;calcDistance();}

/* FULLSCREEN (APP ONLY) */
fullscreenToggle.onclick=()=>{
 const app=document.getElementById('app');
 if(!document.fullscreenElement) app.requestFullscreen();
 else document.exitFullscreen();
};
document.addEventListener('fullscreenchange',()=>setTimeout(()=>map.invalidateSize(),300));

/* OFFLINE */
function net(){offline.style.display=navigator.onLine?'none':'block';}
window.addEventListener('online',net);
window.addEventListener('offline',net);
net();

/* PWA */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
 e.preventDefault();
 deferredPrompt=e;
 installBtn.style.display='block';
});
installBtn.onclick=async()=>{
 deferredPrompt.prompt();
 await deferredPrompt.userChoice;
 deferredPrompt=null;
 installBtn.style.display='none';
};

if('serviceWorker' in navigator)
 navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
