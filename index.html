<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naviser Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b1220">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{margin:0;background:#0b1220;color:#fff;font-family:system-ui}
#app{max-width:480px;margin:auto;padding:8px;display:flex;flex-direction:column; height:100vh;}
#map{height:60vh; min-height:300px;border-radius:16px;flex:1}
#app.fullscreen #map{height:calc(100vh - 300px); min-height:300px; border-radius:0;}
.panel{
background:rgba(255,255,255,.1);
backdrop-filter:blur(10px);
border-radius:14px;padding:8px;margin-top:6px;font-size:13px
}
button,select,input{
width:100%;margin-top:4px;padding:8px;
border-radius:10px;border:none;
background:#1e293b;color:#fff
}
footer{text-align:center;font-size:11px;opacity:.6;margin-top:8px}

/* NORTH ARROW */
#northArrow{position:fixed;top:14px;left:14px;width:42px;height:42px;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:99999;pointer-events:none;transition:opacity 0.3s}

/* FLOATING FULLSCREEN BUTTON */
#floatFS{position:fixed;bottom:20px;right:16px;width:52px;height:52px;border-radius:50%;background:#1e293b;border:none;color:#fff;font-size:20px;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,.5);opacity:0.5;transition: opacity 0.3s;cursor:pointer;}
#floatFS:hover,#floatFS:active{opacity:1}

/* SEARCH BAR */
#searchInput{background:#1e293b;color:#fff;font-size:14px;margin-bottom:4px;}
#searchResults{background:#1e293b;max-height:120px;overflow:auto;border-radius:10px;margin-top:2px;padding:2px;font-size:12px;}
#searchResults div{padding:4px;cursor:pointer;}
#searchResults div:hover{background:rgba(255,255,255,0.2);}
</style>
</head>
<body>

<div id="northArrow">N</div>
<div id="floatFS">‚õ∂</div>

<div id="app">
<div id="map"></div>

<div class="panel">
<input type="text" id="searchInput" placeholder="üîç Search location">
<div id="searchResults"></div>

<select id="mapStyle">
<option value="street">Street</option>
<option value="sat">Satellite</option>
<option value="terrain">Terrain</option>
<option value="hybrid">Hybrid</option>
</select>

<button id="gpsBtn">üì° Enable GPS</button>
<button id="followBtn">üìç Follow: ON</button>

<div id="gpsStatus">Waiting for GPS‚Ä¶</div>
<div id="loc"></div>
<div id="speed"></div>
<div id="heading"></div>

<button id="calBtn">üß≠ Calibrate Compass</button>
<div id="calMsg"></div>

<button id="addMarkerBtn">‚ûï Add Marker</button>
<button id="removeMarkerBtn">‚ûñ Remove Marker</button>
<button id="dirBtn">üéØ Direction to Marker</button>
<div id="dirInfo"></div>

<button id="startPoly">üìê Start Area</button>
<button id="clearPoly">‚ùå Clear Area</button>

<div id="distance"></div>
<div id="area"></div>

<hr>

<button id="addWpBtn">üìç Add Waypoint</button>
<button id="clearWpBtn">‚ùå Clear Waypoints</button>
<button id="navBtn">üß≠ Start Navigation</button>

<div id="navArrow" style="font-size:30px;text-align:center">‚¨Ü</div>
<div id="remainDist"></div>
<div id="wpInfo"></div>

</div>
<footer>¬© Manik Roy 2026</footer>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>

<script>
// --- MAP ---
let map=L.map('map',{zoomControl:true}).setView([20,78],5);
map.zoomControl.setPosition('topright');

// --- LAYERS ---
let layers={
street:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
sat:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}),
terrain:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17}),
};
let hybridBase=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
let hybridLabels=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:20,opacity:0.7,attribution:'&copy; OpenStreetMap &copy; Carto'});
let hybrid=L.layerGroup([hybridBase,hybridLabels]);
layers.hybrid=hybrid;
layers.street.addTo(map);
map.on('zoomend',()=>{if(map.hasLayer(hybridLabels)){if(map.getZoom()<=12) hybridLabels.setOpacity(0); else hybridLabels.setOpacity(0.7);}});

// --- VARIABLES ---
let userMarker,watchId;
let follow=true;
let markers=[],line;
let polyPoints=[],poly;
let waypoints=[],navActive=false,currentWP=0;
let headingAngle=0;

// --- MAP SWITCH ---
mapStyle.onchange=()=>{
map.eachLayer(l=>map.removeLayer(l));
if(mapStyle.value==="hybrid") layers.hybrid.addTo(map);
else layers[mapStyle.value].addTo(map);
if(userMarker) userMarker.addTo(map);
if(line) line.addTo(map);
if(poly) poly.addTo(map);
map.invalidateSize();
};

// --- FOLLOW ---
followBtn.onclick=()=>{follow=!follow; followBtn.innerText="üìç Follow: "+(follow?"ON":"OFF");}
map.on('dragstart zoomstart',()=>{follow=false; followBtn.innerText="üìç Follow: OFF";});

// --- GPS ---
gpsBtn.onclick=startGPS;
function startGPS(){
gpsStatus.innerText="üì° Searching‚Ä¶";
gpsBtn.style.display="none";
watchId=navigator.geolocation.watchPosition(pos=>{
let c=pos.coords;
gpsStatus.innerText="‚úÖ GPS Active";
if(!userMarker){userMarker=L.marker([c.latitude,c.longitude]).addTo(map); if(follow) map.setView([c.latitude,c.longitude],16);}
else{userMarker.setLatLng([c.latitude,c.longitude]); if(follow) map.panTo([c.latitude,c.longitude]);}
loc.innerText=`üìç ${c.latitude.toFixed(5)}, ${c.longitude.toFixed(5)}`;
speed.innerText=`üöÄ Speed: ${(c.speed?c.speed*3.6:0).toFixed(1)} km/h`;
updateNav(c.latitude,c.longitude);
map.invalidateSize();
},err=>{gpsStatus.innerText="‚ùå GPS Denied"; gpsBtn.style.display="block";},{enableHighAccuracy:true});
}

// --- FULLSCREEN ---
const floatFS=document.getElementById("floatFS");
floatFS.onclick=()=>{
if(!document.fullscreenElement){app.requestFullscreen(); app.classList.add("fullscreen"); floatFS.innerText="‚ùé";}
else{document.exitFullscreen(); app.classList.remove("fullscreen"); floatFS.innerText="‚õ∂";}
setTimeout(()=>map.invalidateSize(),300);
}

// --- AUTO FADE BUTTON ---
let hideTimeout;
function autoFadeFS(){ floatFS.style.opacity="1"; document.getElementById('northArrow').style.opacity="1"; clearTimeout(hideTimeout); hideTimeout=setTimeout(()=>{ floatFS.style.opacity="0.5"; document.getElementById('northArrow').style.opacity="0.5"; },3000);}
document.addEventListener("mousemove", autoFadeFS);
document.addEventListener("touchstart", autoFadeFS);

// --- COMPASS ---
if(window.DeviceOrientationEvent){window.addEventListener('deviceorientation',e=>{if(e.alpha!=null){headingAngle=360-e.alpha;document.getElementById('northArrow').style.transform=`rotate(${headingAngle}deg)`;document.getElementById('heading').innerText=`Heading: ${Math.round(headingAngle)}¬∞`;}})}

// --- MARKERS & POLYGON ---
addMarkerBtn.onclick=()=>{ let m=L.marker(map.getCenter(),{draggable:true}).addTo(map); m.on('drag',updateMetrics); markers.push(m); updateMetrics();}
removeMarkerBtn.onclick=()=>{ if(markers.length){map.removeLayer(markers.pop()); updateMetrics();} }
startPoly.onclick=()=>{ polyPoints=markers.map(m=>m.getLatLng()); if(poly) map.removeLayer(poly); poly=L.polygon(polyPoints).addTo(map); updateMetrics();}
clearPoly.onclick=()=>{ if(poly) map.removeLayer(poly); poly=null; area.innerText=''; distance.innerText='';}
function updateMetrics(){ if(line) map.removeLayer(line); if(markers.length>1){line=L.polyline(markers.map(m=>m.getLatLng())).addTo(map); let d=0; for(let i=1;i<markers.length;i++) d+=markers[i-1].getLatLng().distanceTo(markers[i].getLatLng()); distance.innerText=`Distance: ${(d/1000).toFixed(2)} km`; } if(polyPoints.length>2){ let a=L.GeometryUtil.geodesicArea(polyPoints); area.innerText=`Area: ${(a/1e6).toFixed(3)} km¬≤`; }}

// --- DIRECTION TO MARKER ---
dirBtn.onclick=()=>{ if(!markers.length) return alert('Add a marker first!'); let userLat=userMarker?userMarker.getLatLng().lat:0; let userLng=userMarker?userMarker.getLatLng().lng:0; let m=markers[0].getLatLng(); let angle=Math.atan2(m.lng-userLng,m.lat-userLat)*180/Math.PI; dirInfo.innerText=`Direction: ${Math.round(angle)}¬∞`;}

// --- WAYPOINTS & NAVIGATION ---
addWpBtn.onclick=()=>{ if(!userMarker) return; waypoints.push(userMarker.getLatLng()); wpInfo.innerText=`Waypoints: ${waypoints.length}`;}
clearWpBtn.onclick=()=>{ waypoints=[]; wpInfo.innerText='Waypoints cleared'; navActive=false; navArrow.innerText='‚¨Ü'; remainDist.innerText=''; currentWP=0;}
navBtn.onclick=()=>{ if(!waypoints.length) return; navActive=true; currentWP=0;}
function updateNav(lat,lng){ if(!navActive || !waypoints.length) return; let wp=waypoints[currentWP]; let d=map.distance([lat,lng],wp); remainDist.innerText=`Distance to WP${currentWP+1}: ${(d/1000).toFixed(2)} km`; let angle=Math.atan2(wp.lng-lng,wp.lat-lat)*180/Math.PI; let arrow=document.getElementById('navArrow'); let rot=angle-headingAngle; arrow.style.transform=`rotate(${rot}deg)`; if(d<10){currentWP++; if(currentWP>=waypoints.length){navActive=false; arrow.innerText='‚úÖ'; remainDist.innerText='Arrived';}}}
setInterval(()=>{ if(userMarker){ let p=userMarker.getLatLng(); updateNav(p.lat,p.lng); } },500);

// --- LOCATION SEARCH ---
searchInput.addEventListener("input",()=>{ let q=searchInput.value.trim(); if(!q){searchResults.innerHTML=''; return;} fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`) .then(res=>res.json()) .then(data=>{ searchResults.innerHTML=''; data.slice(0,5).forEach(loc=>{ let div=document.createElement('div'); div.innerText=loc.display_name; div.onclick=()=>{ map.setView([loc.lat,loc.lon],16); searchResults.innerHTML=''; }; searchResults.appendChild(div); }); }); });

// --- SERVICE WORKER (PWA) ---
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').then(reg=>{console.log("SW registered:",reg);}).catch(err=>console.error("SW failed:",err)); }
</script>
</body>
</html>
