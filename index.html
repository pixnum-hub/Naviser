<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naviser Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;background:#0b1220;color:#fff;font-family:system-ui}
#app{max-width:480px;margin:auto;padding:8px}
#map{height:60vh;border-radius:16px}

.panel{
background:rgba(255,255,255,.1);
backdrop-filter:blur(10px);
border-radius:14px;padding:8px;margin-top:6px;font-size:13px
}

button,select{
width:100%;margin-top:4px;padding:8px;
border-radius:10px;border:none;
background:#1e293b;color:#fff
}

footer{text-align:center;font-size:11px;opacity:.6;margin-top:8px}

/* FULLSCREEN */
#app.fullscreen{
width:100vw;height:100vh;padding:0
}
#app.fullscreen #map{
height:100vh;border-radius:0
}

/* NORTH OVERLAY */
#northArrow{
position:fixed;
top:14px;left:14px;
width:42px;height:42px;
border-radius:50%;
background:#1e293b;
display:flex;
align-items:center;
justify-content:center;
font-weight:bold;
z-index:9999;
}
</style>
</head>

<body>

<div id="northArrow">N</div>

<div id="app">

<div id="map"></div>

<div class="panel">

<select id="mapStyle">
<option value="street">Street</option>
<option value="sat">Satellite</option>
<option value="terrain">Terrain</option>
<option value="hybrid">Hybrid</option>
</select>

<button id="gpsBtn">ğŸ“¡ Enable GPS</button>
<button id="followBtn">ğŸ“ Follow: ON</button>
<button id="fsBtn">â›¶ Fullscreen</button>

<div id="gpsStatus">Waiting for GPSâ€¦</div>
<div id="loc"></div>
<div id="speed"></div>
<div id="heading"></div>

<button id="calBtn">ğŸ§­ Calibrate Compass</button>
<div id="calMsg"></div>

<button id="addMarkerBtn">â• Add Marker</button>
<button id="removeMarkerBtn">â– Remove Marker</button>
<button id="dirBtn">ğŸ¯ Direction to Marker</button>
<div id="dirInfo"></div>

<button id="startPoly">ğŸ“ Start Area</button>
<button id="clearPoly">âŒ Clear Area</button>

<div id="distance"></div>
<div id="area"></div>

<hr>

<button id="addWpBtn">ğŸ“ Add Waypoint</button>
<button id="clearWpBtn">âŒ Clear Waypoints</button>
<button id="navBtn">ğŸ§­ Start Navigation</button>

<div id="navArrow" style="font-size:30px;text-align:center"></div>
<div id="remainDist"></div>
<div id="wpInfo"></div>

</div>

<footer>Â© Manik Roy 2026</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>

<script>
/* MAP */
let map=L.map('map').setView([20,78],5);

let layers={
street:L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:19}
),
sat:L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{maxZoom:19}
),
terrain:L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',
{maxZoom:18}
),
hybrid:L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{maxZoom:19}
)
};

layers.street.addTo(map);

/* VARIABLES */
let userMarker,watchId;
let follow=true;
let markers=[],line;
let polyPoints=[],poly;
let targetMarker=null;

/* WAYPOINT */
let waypoints=[],navActive=false,currentWP=0;

/* MAP SWITCH */
mapStyle.onchange=()=>{
map.eachLayer(l=>map.removeLayer(l));
layers[mapStyle.value].addTo(map);
if(userMarker) userMarker.addTo(map);
if(line) line.addTo(map);
if(poly) poly.addTo(map);
};

/* FOLLOW */
followBtn.onclick=()=>{
follow=!follow;
followBtn.innerText="ğŸ“ Follow: "+(follow?"ON":"OFF");
}
map.on('dragstart zoomstart',()=>{
follow=false;
followBtn.innerText="ğŸ“ Follow: OFF";
});

/* GPS */
gpsBtn.onclick=startGPS;

function startGPS(){
gpsStatus.innerText="ğŸ“¡ Searchingâ€¦";
gpsBtn.style.display="none";

watchId=navigator.geolocation.watchPosition(pos=>{
let c=pos.coords;
gpsStatus.innerText="âœ… GPS Active";

if(!userMarker){
userMarker=L.marker([c.latitude,c.longitude]).addTo(map);
if(follow) map.setView([c.latitude,c.longitude],16);
}else{
userMarker.setLatLng([c.latitude,c.longitude]);
if(follow) map.panTo([c.latitude,c.longitude]);
}

loc.innerText=`ğŸ“ ${c.latitude.toFixed(5)}, ${c.longitude.toFixed(5)}`;
speed.innerText=`ğŸš€ Speed: ${(c.speed?c.speed*3.6:0).toFixed(1)} km/h`;

/* NAV UPDATE */
if(navActive) navUpdate(c.latitude,c.longitude);

},err=>{
gpsStatus.innerText="âŒ GPS Denied";
gpsBtn.style.display="block";
},{enableHighAccuracy:true});
}

/* FULLSCREEN */
fsBtn.onclick=()=>{
if(!document.fullscreenElement){
app.requestFullscreen();
app.classList.add("fullscreen");
fsBtn.innerText="â Exit Fullscreen";
}else{
document.exitFullscreen();
app.classList.remove("fullscreen");
fsBtn.innerText="â›¶ Fullscreen";
}
};

/* MARKERS */
addMarkerBtn.onclick=()=>{
let m=L.marker(map.getCenter(),{draggable:true}).addTo(map);
m.on('drag',calcDist);
markers.push(m);
calcDist();
}
removeMarkerBtn.onclick=()=>{
if(markers.length){
map.removeLayer(markers.pop());
calcDist();
}
}

/* DISTANCE */
function calcDist(){
if(line) map.removeLayer(line);
if(markers.length>1){
line=L.polyline(markers.map(m=>m.getLatLng())).addTo(map);
let d=0;
for(let i=1;i<markers.length;i++)
d+=markers[i-1].getLatLng().distanceTo(markers[i].getLatLng());
distance.innerText=`ğŸ“ Distance: ${(d/1000).toFixed(2)} km`;
}else distance.innerText="";
}

/* AREA */
startPoly.onclick=()=>{
map.once('click',e=>{
polyPoints.push(e.latlng);
drawPoly();
startPoly.click();
});
}
clearPoly.onclick=()=>{
polyPoints=[];
if(poly) map.removeLayer(poly);
area.innerText="";
}
function drawPoly(){
if(poly) map.removeLayer(poly);
poly=L.polygon(polyPoints).addTo(map);
if(polyPoints.length>2){
let a=L.GeometryUtil.geodesicArea(polyPoints);
area.innerText=`ğŸ“ Area: ${(a/1000000).toFixed(3)} kmÂ²`;
}
}

/* COMPASS */
let offset=0,lastHeading=null;
let declination=2; // India approx

function initCompass(){
if(window.DeviceOrientationEvent){
if(typeof DeviceOrientationEvent.requestPermission==="function"){
DeviceOrientationEvent.requestPermission().then(p=>{
if(p==="granted") startCompass();
});
}else startCompass();
}
}
function startCompass(){
window.addEventListener("deviceorientationabsolute",handleCompass,true);
window.addEventListener("deviceorientation",handleCompass,true);
}

function handleCompass(e){
let raw;
if(e.webkitCompassHeading){
raw=e.webkitCompassHeading;
}
else if(e.absolute && e.alpha!=null){
raw=360-e.alpha;
}else return;

raw=(raw+360)%360;

let heading=(raw+offset+declination+360)%360;

if(lastHeading!=null)
heading=lastHeading+(heading-lastHeading)*0.15;

lastHeading=heading;
heading=Math.round(heading);

headingEl.innerText=`ğŸ§­ Heading: ${heading}Â°`;
}

/* CALIBRATION */
calBtn.onclick=()=>{
calMsg.innerText="Rotate phone in figure 8 for 5 sec...";
let samples=[];
let temp=(e)=>{
let h;
if(e.webkitCompassHeading) h=e.webkitCompassHeading;
else if(e.alpha!=null) h=360-e.alpha;
if(h!=null) samples.push(h);
};
window.addEventListener("deviceorientation",temp,true);

setTimeout(()=>{
window.removeEventListener("deviceorientation",temp);
let avg=samples.reduce((a,b)=>a+b,0)/samples.length;
offset=360-avg;
calMsg.innerText="âœ… Calibration done";
},5000);
}

/* BEARING */
function bearing(lat1,lng1,lat2,lng2){
let dLon=(lng2-lng1)*Math.PI/180;
let y=Math.sin(dLon)*Math.cos(lat2*Math.PI/180);
let x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-
Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon);
return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* TARGET DIRECTION */
dirBtn.onclick=()=>{
if(!markers.length){
alert("Add marker first");
return;
}
targetMarker=markers[markers.length-1];
dirInfo.innerText="ğŸ¯ Target locked";
}

/* WAYPOINTS */
addWpBtn.onclick=()=>{
if(!userMarker){alert("Enable GPS");return;}
waypoints.push(userMarker.getLatLng());
wpInfo.innerText=`ğŸ“ Waypoints: ${waypoints.length}`;
}

clearWpBtn.onclick=()=>{
waypoints=[];
currentWP=0;
navActive=false;
wpInfo.innerText="";
navArrow.innerText="";
remainDist.innerText="";
navBtn.innerText="ğŸ§­ Start Navigation";
}

/* NAV */
navBtn.onclick=()=>{
if(!waypoints.length){
alert("Add waypoint");
return;
}
navActive=!navActive;
navBtn.innerText=navActive?"ğŸ›‘ Stop":"ğŸ§­ Start Navigation";
}

/* TURN ARROW */
function getTurn(diff){
if(diff<20||diff>340) return "â¬†ï¸ Go Straight";
if(diff<60) return "â†—ï¸ Slight Right";
if(diff<120) return "â¡ï¸ Turn Right";
if(diff<160) return "â†˜ï¸ Sharp Right";
if(diff<200) return "â¬‡ï¸ U-Turn";
if(diff<240) return "â†™ï¸ Sharp Left";
if(diff<300) return "â¬…ï¸ Turn Left";
return "â†–ï¸ Slight Left";
}

function navUpdate(lat,lng){
let target=waypoints[currentWP];

let b=bearing(lat,lng,target.lat,target.lng);

let d=L.latLng(lat,lng).distanceTo(target);
remainDist.innerText=
`ğŸ“ Remaining: ${(d/1000).toFixed(2)} km`;

let diff=(b-lastHeading+360)%360;
navArrow.innerText=getTurn(diff);

if(d<15){
currentWP++;
if(currentWP>=waypoints.length){
navArrow.innerText="ğŸ Destination reached";
navActive=false;
navBtn.innerText="ğŸ§­ Start Navigation";
}else{
wpInfo.innerText=`â¡ Next waypoint ${currentWP+1}`;
}
}
}

initCompass();
</script>
</body>
</html>
