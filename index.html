<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naviser Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{margin:0;background:#0b1220;color:#fff;font-family:system-ui;overflow:hidden;}
#app{max-width:480px;margin:auto;position:relative;}
#map{width:100%;height:60vh;border-radius:16px;}
#app.fullscreen #map{height:100vh;border-radius:0;}

/* Panels overlay */
.panel{
position:absolute;background:rgba(255,255,255,0.1);
backdrop-filter:blur(10px);
border-radius:14px;padding:8px;font-size:13px;
overflow:auto;max-height:45vh;z-index:99990;color:#fff;
}
#searchPanel{top:10px;left:10px;right:10px;}
#mainPanel{bottom:10px;left:10px;right:10px;}

/* Search results */
#searchResults{background:#1e293b;max-height:120px;overflow:auto;border-radius:10px;margin-top:2px;padding:2px;font-size:12px;}
#searchResults div{padding:4px;cursor:pointer;}
#searchResults div:hover{background:rgba(255,255,255,0.2);}

/* North arrow */
#northArrow{position:fixed;top:14px;left:14px;width:42px;height:42px;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:99999;pointer-events:none;transition:opacity 0.3s;}

/* Floating fullscreen */
#floatFS{position:fixed;bottom:20px;right:16px;width:52px;height:52px;border-radius:50%;background:#1e293b;border:none;color:#fff;font-size:20px;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,.5);opacity:0.5;transition: opacity 0.3s;cursor:pointer;}
#floatFS:hover,#floatFS:active{opacity:1;}
footer{text-align:center;font-size:11px;opacity:.6;margin-top:8px;}
</style>
</head>
<body>

<div id="northArrow">N</div>
<div id="floatFS">‚õ∂</div>
<div id="app"><div id="map"></div></div>

<!-- Search Panel -->
<div id="searchPanel" class="panel">
<input type="text" id="searchInput" placeholder="üîç Search location">
<div id="searchResults"></div>
</div>

<!-- Main Panel -->
<div id="mainPanel" class="panel">
<select id="mapStyle">
<option value="street">Street</option>
<option value="sat">Satellite</option>
<option value="terrain">Terrain</option>
<option value="hybrid">Hybrid</option>
</select>

<button id="gpsBtn">üì° Enable GPS</button>
<button id="followBtn">üìç Follow: ON</button>
<div id="gpsStatus">Waiting for GPS‚Ä¶</div>
<div id="loc"></div>
<div id="speed"></div>
<div id="heading"></div>

<button id="addMarkerBtn">‚ûï Add Marker</button>
<button id="removeMarkerBtn">‚ûñ Remove Marker</button>
<button id="dirBtn">üéØ Direction to Marker</button>
<div id="dirInfo"></div>

<button id="startPoly">üìê Start Area</button>
<button id="clearPoly">‚ùå Clear Area</button>
<div id="distance"></div>
<div id="area"></div>

<hr>
<button id="addWpBtn">üìç Add Waypoint</button>
<button id="clearWpBtn">‚ùå Clear Waypoints</button>
<button id="navBtn">üß≠ Start Navigation</button>
<div id="navArrow" style="font-size:30px;text-align:center">‚¨Ü</div>
<div id="remainDist"></div>
<div id="wpInfo"></div>

<hr>
<button id="downloadAreaBtn">‚¨áÔ∏è Download Map Area</button>
<button id="cancelDownloadBtn">‚ùå Cancel Download</button>
</div>

<footer>¬© Manik Roy 2026</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/iife/index-min.js"></script>

<script>
// --- MAP ---
let map=L.map('map',{zoomControl:true}).setView([20,78],5);
map.zoomControl.setPosition('topright');

// --- OFFLINE TILE LAYER CLASS ---
class OfflineTileLayer extends L.TileLayer {
  constructor(urlTemplate, options){
    super(urlTemplate, options);
    this.dbPromise = idb.openDB('naviserTiles',1,{upgrade(db){db.createObjectStore('tiles');}});
  }
  createTile(coords, done){
    const tile = document.createElement('img');
    const url = this.getTileUrl(coords);
    tile.alt='';
    tile.onload = () => done(null, tile);
    tile.onerror = () => done(new Error('Tile error'), tile);
    this._loadTile(url, tile);
    return tile;
  }
  async _loadTile(url, tile){
    const db = await this.dbPromise;
    try {
      const cached = await db.get('tiles', url);
      if(cached){tile.src = cached;}
      else {
        tile.crossOrigin=''; tile.src=url;
        tile.onload = async ()=>{
          const canvas=document.createElement('canvas'); canvas.width=tile.width; canvas.height=tile.height;
          const ctx=canvas.getContext('2d'); ctx.drawImage(tile,0,0);
          await db.put('tiles', canvas.toDataURL('image/png'), url);
        }
      }
    } catch(e){console.error('Tile error',e); tile.src=url;}
  }
}

// --- LAYERS ---
let layers={
street:new OfflineTileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
sat:new OfflineTileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}),
terrain:new OfflineTileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17}),
};
let hybridBase = new OfflineTileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
let hybridLabels = new OfflineTileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{
subdomains:'abcd',maxZoom:20,opacity:0.7});
layers.hybrid=L.layerGroup([hybridBase, hybridLabels]);
layers.street.addTo(map);

// --- VARIABLES ---
let userMarker,watchId,follow=true,markers=[],line;
let polyPoints=[],poly;
let waypoints=[],navActive=false,currentWP=0;

// --- MAP SWITCH ---
mapStyle.onchange=()=>{
map.eachLayer(l=>map.removeLayer(l));
if(mapStyle.value==="hybrid") layers.hybrid.addTo(map);
else layers[mapStyle.value].addTo(map);
if(userMarker) userMarker.addTo(map);
if(line) line.addTo(map);
if(poly) poly.addTo(map);
};

// --- FOLLOW ---
followBtn.onclick=()=>{follow=!follow; followBtn.innerText="üìç Follow: "+(follow?"ON":"OFF");}
map.on('dragstart zoomstart',()=>{follow=false; followBtn.innerText="üìç Follow: OFF";});

// --- GPS ---
gpsBtn.onclick=startGPS;
function startGPS(){
gpsStatus.innerText="üì° Searching‚Ä¶";
gpsBtn.style.display="none";
watchId=navigator.geolocation.watchPosition(pos=>{
let c=pos.coords;
gpsStatus.innerText="‚úÖ GPS Active";
if(!userMarker){userMarker=L.marker([c.latitude,c.longitude]).addTo(map); if(follow) map.setView([c.latitude,c.longitude],16);}
else{userMarker.setLatLng([c.latitude,c.longitude]); if(follow) map.panTo([c.latitude,c.longitude]);}
loc.innerText=`üìç ${c.latitude.toFixed(5)}, ${c.longitude.toFixed(5)}`;
speed.innerText=`üöÄ Speed: ${(c.speed?c.speed*3.6:0).toFixed(1)} km/h`;
updateNav(c.latitude,c.longitude);
},err=>{gpsStatus.innerText="‚ùå GPS Denied"; gpsBtn.style.display="block";},{enableHighAccuracy:true});
}

// --- FULLSCREEN ---
floatFS.onclick=()=>{
if(!document.fullscreenElement){app.requestFullscreen(); app.classList.add("fullscreen"); floatFS.innerText="‚ùé";}
else{document.exitFullscreen(); app.classList.remove("fullscreen"); floatFS.innerText="‚õ∂";}
}
let hideTimeout;
function autoFadeFS(){ floatFS.style.opacity="1"; document.getElementById('northArrow').style.opacity="1";
clearTimeout(hideTimeout); hideTimeout=setTimeout(()=>{floatFS.style.opacity="0.5"; document.getElementById('northArrow').style.opacity="0.5";},3000);}
document.addEventListener("mousemove",autoFadeFS);document.addEventListener("touchstart",autoFadeFS);

// --- COMPASS ---
let headingAngle=0;
if(window.DeviceOrientationEvent){
window.addEventListener('deviceorientation', e=>{
if(e.alpha!=null){headingAngle = 360-e.alpha; document.getElementById('northArrow').style.transform=`rotate(${headingAngle}deg)`; document.getElementById('heading').innerText=`Heading: ${Math.round(headingAngle)}¬∞`; }
});
}

// --- MARKERS & POLYGON ---
addMarkerBtn.onclick=()=>{ let m=L.marker(map.getCenter(),{draggable:true}).addTo(map); m.on('drag',updateMetrics); markers.push(m); updateMetrics();}
removeMarkerBtn.onclick=()=>{ if(markers.length){map.removeLayer(markers.pop()); updateMetrics();} }
startPoly.onclick=()=>{ polyPoints=markers.map(m=>m.getLatLng()); if(poly) map.removeLayer(poly); poly=L.polygon(polyPoints).addTo(map); updateMetrics();}
clearPoly.onclick=()=>{ if(poly) map.removeLayer(poly); poly=null; area.innerText=''; distance.innerText='';}
function updateMetrics(){ if(line) map.removeLayer(line); if(markers.length>1){line=L.polyline(markers.map(m=>m.getLatLng())).addTo(map); let d=0;for(let i=1;i<markers.length;i++)d+=markers[i-1].getLatLng().distanceTo(markers[i].getLatLng()); distance.innerText=`Distance: ${(d/1000).toFixed(2)} km`; } if(polyPoints.length>2){ let a=L.GeometryUtil.geodesicArea(polyPoints); area.innerText=`Area: ${(a/1e6).toFixed(3)} km¬≤`; }}

// --- DIRECTION ---
dirBtn.onclick=()=>{
if(!markers.length)return alert('Add a marker first!');
let userLat=userMarker?userMarker.getLatLng().lat:0;
let userLng=userMarker?userMarker.getLatLng().lng:0;
let m=markers[0].getLatLng();
let angle=Math.atan2(m.lng-userLng,m.lat-userLat)*180/Math.PI;
dirInfo.innerText=`Direction: ${Math.round(angle)}¬∞`;
}

// --- WAYPOINTS & NAVIGATION ---
addWpBtn.onclick=()=>{ if(!userMarker)return; waypoints.push(userMarker.getLatLng()); wpInfo.innerText=`Waypoints: ${waypoints.length}`;}
clearWpBtn.onclick=()=>{ waypoints=[]; wpInfo.innerText='Waypoints cleared'; navActive=false; navArrow.innerText='‚¨Ü'; remainDist.innerText=''; currentWP=0;}
navBtn.onclick=()=>{ if(!waypoints.length) return; navActive=true; currentWP=0;}
function updateNav(lat,lng){
if(!navActive || !waypoints.length) return;
let wp=waypoints[currentWP];
let d=map.distance([lat,lng],wp);
remainDist.innerText=`Distance to WP${currentWP+1}: ${(d/1000).toFixed(2)} km`;
let angle=Math.atan2(wp.lng-lng, wp.lat-lat)*180/Math.PI;
let arrow=document.getElementById('navArrow');
let rot=angle-headingAngle;
arrow.style.transform=`rotate(${rot}deg)`;
if(d<10){currentWP++; if(currentWP>=waypoints.length){navActive=false; arrow.innerText='‚úÖ'; remainDist.innerText='Arrived';}}
}
setInterval(()=>{ if(userMarker){ let p=userMarker.getLatLng(); updateNav(p.lat,p.lng); } },500);

// --- SEARCH ---
searchInput.addEventListener("input",()=>{
let q=searchInput.value.trim(); if(!q){searchResults.innerHTML='';return;}
fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`).then(res=>res.json()).then(data=>{
searchResults.innerHTML=''; data.slice(0,5).forEach(loc=>{ let div=document.createElement('div'); div.innerText=loc.display_name; div.onclick=()=>{ map.setView([loc.lat,loc.lon],16); searchResults.innerHTML='';}; searchResults.appendChild(div);});
});
});

// --- OPTIMIZED DOWNLOAD AREA ---
let downloadAbort = false;
downloadAreaBtn.onclick = async () => {
if (!map.getBounds()) return alert('Zoom/pan to area!');
downloadAbort=false;
const bounds=map.getBounds(); const zmin=5,zmax=15; let tiles=[];
for(let z=zmin;z<=zmax;z++){
const nw=map.project(bounds.getNorthWest(), z); const se=map.project(bounds.getSouthEast(), z);
for(let x=Math.floor(nw.x/256); x<=Math.floor(se.x/256); x++){ for(let y=Math.floor(nw.y/256); y<=Math.floor(se.y/256); y++){ tiles.push({x,y,z}); } } }
if(!tiles.length) return alert('No tiles to download!');
const db=await idb.openDB('naviserTiles',1);
let downloaded=0;
const progressDiv=document.createElement('div');
progressDiv.style.position='fixed'; progressDiv.style.top='50%'; progressDiv.style.left='50%';
progressDiv.style.transform='translate(-50%,-50%)'; progressDiv.style.background='rgba(0,0,0,0.8)';
progressDiv.style.color='#fff'; progressDiv.style.padding='12px'; progressDiv.style.borderRadius='10px';
progressDiv.style.zIndex='100000'; progressDiv.innerText=`Downloading tiles: 0/${tiles.length}`;
document.body.appendChild(progressDiv);
const batchSize=5;
for(let i=0;i<tiles.length;i+=batchSize){
if(downloadAbort) break;
const batch=tiles.slice(i,i+batchSize);
await Promise.all(batch.map(async t=>{
try{
const layer=layers[mapStyle.value]; const url=layer.getTileUrl(t);
const img=new Image(); img.crossOrigin=''; img.src=url;
await new Promise(res=>img.onload=res);
const canvas=document.createElement('canvas'); canvas.width=img.width; canvas.height=img.height;
const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
await db.put('tiles',canvas.toDataURL('image/png'), url);
}catch(e){console.warn('Tile fail',e);}
}));
downloaded+=batch.length;
progressDiv.innerText=`Downloading tiles: ${downloaded}/${tiles.length}`;
await new Promise(r=>setTimeout(r,50));
}
progressDiv.innerText=downloadAbort?'Download aborted!':'Download complete!';
setTimeout(()=>document.body.removeChild(progressDiv),2000);
}

// --- CANCEL DOWNLOAD ---
cancelDownloadBtn.onclick=()=>{downloadAbort=true; alert('Download canceled');}
</script>
</body>
</html>
