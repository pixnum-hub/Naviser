<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naviser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;background:#0b1220;font-family:system-ui;color:#fff;display:flex;justify-content:center}
#app{width:100%;max-width:480px;padding:10px;position:relative}
#map{height:55vh;border-radius:18px;overflow:hidden}
.panel{background:rgba(255,255,255,.12);backdrop-filter:blur(12px);border-radius:14px;padding:10px;margin-top:8px}
button{border:none;border-radius:12px;padding:8px;font-size:13px;background:#1e293b;color:#fff}
button:active{transform:scale(.97)}
#floating{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:8px;z-index:3000}
.round{width:40px;height:40px;border-radius:50%}

/* Compass */
#compassWrap{display:flex;align-items:center;gap:10px}
#compassRing{width:40px;height:40px;border-radius:50%;border:2px solid #94a3b8;position:relative}
#needle{width:2px;height:18px;background:red;position:absolute;left:50%;top:2px;transform-origin:bottom}

/* Route list */
.route{display:flex;justify-content:space-between;margin:4px 0;font-size:12px}

/* Fullscreen */
#app:fullscreen{padding:0}
#app:fullscreen #map{height:100vh;border-radius:0}
#app:fullscreen .hideFS{display:none}
</style>
</head>

<body>
<div id="app">

<div id="floating">
<button id="fsBtn" class="round">â›¶</button>
<button id="layerBtn" class="round">ğŸ—ºï¸</button>
</div>

<div id="map"></div>

<div class="panel">
<div id="loc">ğŸ“ Waiting for GPSâ€¦</div>
<div id="speed">ğŸ“¡ Speed: 0 km/h</div>
<div id="bearing">ğŸ§­ Bearing: 0Â°</div>

<div id="compassWrap">
<div id="compassRing"><div id="needle"></div></div>
<div id="heading">Heading: 0Â°</div>
</div>

<div id="distance">ğŸ“ Distance: 0 km</div>
<div id="area">ğŸ“ Area: 0</div>
</div>

<div class="panel hideFS">
<button onclick="addMarker()">â• Marker</button>
<button onclick="removeMarker()">â– Marker</button>
<button onclick="toggleUnit()">â†” Units</button>
<button onclick="saveRoute()">ğŸ’¾ Save Route</button>
<button onclick="clearArea()">âŒ Clear Area</button>
</div>

<div class="panel hideFS">
<b>Saved Routes</b>
<div id="routes"></div>
</div>

<footer class="hideFS" style="text-align:center;font-size:11px;opacity:.6">
Â© Manik Roy 2025. All Rights Reserved.
</footer>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>

<script>
let map=L.map('map').setView([20,78],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker,lastPos=null,markers=[],poly,line;
let km=true,spdAvg=0;

/* GPS */
navigator.geolocation.watchPosition(p=>{
 const c=p.coords;
 if(!userMarker){
  userMarker=L.marker([c.latitude,c.longitude]).addTo(map);
  map.setView([c.latitude,c.longitude],15);
 } else userMarker.setLatLng([c.latitude,c.longitude]);

 loc.innerHTML=`ğŸ“ ${c.latitude.toFixed(5)}, ${c.longitude.toFixed(5)}`;

 let spd=(c.speed||0)*3.6;
 spdAvg=spdAvg*0.7+spd*0.3;
 speed.innerText=`ğŸ“¡ Speed: ${spdAvg.toFixed(1)} ${km?'km/h':'mph'}`;

 if(lastPos){
  let b=bearingCalc(lastPos.lat,lastPos.lng,c.latitude,c.longitude);
  bearing.innerText=`ğŸ§­ Bearing: ${Math.round(b)}Â°`;
 }
 lastPos={lat:c.latitude,lng:c.longitude};
},{enableHighAccuracy:true});

/* Compass */
if(window.DeviceOrientationEvent){
 window.addEventListener('deviceorientation',e=>{
  if(e.alpha!=null){
   let h=Math.round(360-e.alpha);
   needle.style.transform=`rotate(${h}deg)`;
   heading.innerText=`Heading: ${h}Â°`;
  }
 });
}

/* Markers */
function addMarker(){
 let m=L.marker(map.getCenter(),{draggable:true}).addTo(map);
 m.on('drag',updateMetrics);
 markers.push(m);
 updateMetrics();
}
function removeMarker(){
 if(markers.length){
  map.removeLayer(markers.pop());
  updateMetrics();
 }
}

/* Distance + Area */
function updateMetrics(){
 if(line) map.removeLayer(line);
 if(poly) map.removeLayer(poly);

 if(markers.length>1){
  line=L.polyline(markers.map(m=>m.getLatLng())).addTo(map);
  let d=0;
  for(let i=1;i<markers.length;i++)
   d+=markers[i-1].getLatLng().distanceTo(markers[i].getLatLng());
  distance.innerText=`ğŸ“ Distance: ${(km?d/1000:d/1609).toFixed(2)} ${km?'km':'mi'}`;
 }

 if(markers.length>2){
  poly=L.polygon(markers.map(m=>m.getLatLng())).addTo(map);
  let a=L.GeometryUtil.geodesicArea(poly.getLatLngs()[0]);
  area.innerText=`ğŸ“ Area: ${(a/1e6).toFixed(3)} kmÂ² | ${(a*0.000247).toFixed(2)} acres`;
 }
}

/* Save routes */
function saveRoute(){
 let name=prompt('Route name?');
 if(!name||markers.length<2) return;
 let data=JSON.parse(localStorage.getItem('routes')||'{}');
 data[name]=markers.map(m=>m.getLatLng());
 localStorage.setItem('routes',JSON.stringify(data));
 loadRoutes();
}
function loadRoutes(){
 routes.innerHTML='';
 let data=JSON.parse(localStorage.getItem('routes')||'{}');
 for(let k in data){
  let div=document.createElement('div');
  div.className='route';
  div.innerHTML=`${k}<span onclick="loadRoute('${k}')">â–¶</span>`;
  routes.appendChild(div);
 }
}
function loadRoute(n){
 markers.forEach(m=>map.removeLayer(m));
 markers=[];
 JSON.parse(localStorage.getItem('routes'))[n].forEach(p=>{
  let m=L.marker(p,{draggable:true}).addTo(map);
  m.on('drag',updateMetrics);
  markers.push(m);
 });
 updateMetrics();
}
loadRoutes();

/* Utils */
function toggleUnit(){km=!km;updateMetrics();}
function clearArea(){if(poly)map.removeLayer(poly);area.innerText='ğŸ“ Area: 0';}
function bearingCalc(lat1,lng1,lat2,lng2){
 let dLon=(lng2-lng1)*Math.PI/180;
 let y=Math.sin(dLon)*Math.cos(lat2*Math.PI/180);
 let x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-
        Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon);
 return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* Fullscreen */
fsBtn.onclick=()=>!document.fullscreenElement?app.requestFullscreen():document.exitFullscreen();
</script>
</body>
</html>
